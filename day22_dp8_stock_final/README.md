# Day 22: åŠ¨æ€è§„åˆ’ - è‚¡ç¥¨é—®é¢˜ç»ˆæç¯‡ (Stock Series Finale)

**æ—¥æœŸ**: 2026-01-06
**ä¸»é¢˜**: çŠ¶æ€æœº DP (State Machine)
**éš¾åº¦**: Hard / Medium
**æ ‡ç­¾**: #DynamicProgramming #StateMachine

## ğŸ§  æ ¸å¿ƒæ–¹æ³•è®ºï¼šçŠ¶æ€æœºæ¨¡å‹ (The State Machine)

è‚¡ç¥¨é—®é¢˜çš„æœ¬è´¨ä¸æ˜¯é¢„æµ‹è‚¡ä»·æ³¢åŠ¨ï¼Œè€Œæ˜¯**çŠ¶æ€çš„æµè½¬**ã€‚
è§£å†³æ­¤ç±»é—®é¢˜çš„é€šç”¨æ­¥éª¤ï¼š
1.  **å®šä¹‰çŠ¶æ€**ï¼šæ¯å¤©ç»“æŸåï¼Œæˆ‘æ‰‹é‡Œçš„èµ„äº§å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿï¼ˆæŒæœ‰ï¼Ÿç©ºä»“ï¼Ÿå†·å†»ï¼Ÿï¼‰
2.  **ç”»è½¬ç§»å›¾**ï¼šä»Šå¤©çš„çŠ¶æ€ç”±æ˜¨å¤©çš„å“ªäº›çŠ¶æ€æ¼”å˜è€Œæ¥ï¼Ÿ
3.  **ç¡®å®šåŠ¨ä½œ**ï¼šä»€ä¹ˆåŠ¨ä½œå¯¼è‡´äº†çŠ¶æ€å˜åŒ–ï¼Ÿï¼ˆä¹°å…¥æ‰£é’±ï¼Œå–å‡ºåŠ é’±ï¼‰ã€‚

---

## é¢˜ç›®ä¸€ï¼š188. ä¹°å–è‚¡ç¥¨ IV (k æ¬¡äº¤æ˜“)
**éš¾åº¦**: Hard
**é“¾æ¥**: [LeetCode 188](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-iv/)

### ğŸ’¡ è§£é¢˜æ€è·¯
è¿™æ˜¯ "æœ€å¤š2æ¬¡äº¤æ˜“" çš„æ³›åŒ–ç‰ˆæœ¬ã€‚æˆ‘ä»¬éœ€è¦ç»´æŠ¤ $2k+1$ ä¸ªçŠ¶æ€ã€‚
*   `dp[0]`: æ— æ“ä½œ
*   `dp[1]`: ç¬¬ 1 æ¬¡æŒæœ‰ (Buy 1)
*   `dp[2]`: ç¬¬ 1 æ¬¡å–å‡º (Sell 1)
*   ...
*   `dp[2k-1]`: ç¬¬ k æ¬¡æŒæœ‰
*   `dp[2k]`: ç¬¬ k æ¬¡å–å‡º

### ğŸ”¢ çŠ¶æ€è½¬ç§»æ–¹ç¨‹
å¯¹äºç¬¬ `i` æ¬¡äº¤æ˜“ï¼ˆ`j` ä¸ºå¶æ•°ï¼Œ`j+1` ä¸ºä¹°å…¥ï¼Œ`j+2` ä¸ºå–å‡ºï¼‰ï¼š
1.  **ä¹°å…¥æ€**ï¼š`dp[j+1] = max(dp[j+1], dp[j] - price)`
2.  **å–å‡ºæ€**ï¼š`dp[j+2] = max(dp[j+2], dp[j+1] + price)`

### ğŸ’» å…³é”®ä»£ç 
```python
class Solution:
    def maxProfit(self, k: int, prices: List[int]) -> int:
        if not prices or k == 0: return 0
        dp = [0] * (2 * k + 1)
        
        # åˆå§‹åŒ–ï¼šæ‰€æœ‰â€œæŒæœ‰â€çŠ¶æ€åˆå§‹èµ„é‡‘éƒ½ä¸º -prices[0]
        for i in range(1, 2 * k, 2):
            dp[i] = -prices[0]
            
        for price in prices:
            for j in range(0, 2 * k - 1, 2):
                # æ›´æ–°ä¹°å…¥ (ä»ä¸Šä¸€æ¬¡å–å‡ºçŠ¶æ€è½¬ç§»)
                dp[j+1] = max(dp[j+1], dp[j] - price)
                # æ›´æ–°å–å‡º (ä»æœ¬æ¬¡ä¹°å…¥çŠ¶æ€è½¬ç§»)
                dp[j+2] = max(dp[j+2], dp[j+1] + price)
                
        return dp[2 * k]
```

---

## é¢˜ç›®äºŒï¼š309. å«å†·å†»æœŸçš„è‚¡ç¥¨äº¤æ˜“ (Cooldown)
**éš¾åº¦**: Medium
**é“¾æ¥**: [LeetCode 309](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-with-cooldown/)

### ğŸ’¡ è§£é¢˜æ€è·¯ (ä¸‰æ€æ¨¡å‹)
å› ä¸ºæœ‰å†·å†»æœŸï¼Œ"ä¸æŒæœ‰" éœ€è¦æ‹†åˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚
1.  **`hold`**: æŒæœ‰è‚¡ç¥¨ã€‚
2.  **`sold`**: **åˆšåˆšå–å‡º**ï¼ˆæ˜å¤©å°†è¿›å…¥å†·å†»æœŸï¼‰ã€‚
3.  **`rest`**: **ä¼‘æ¯/è‡ªç”±èº«**ï¼ˆæ²¡ç¥¨ï¼Œä¸”ä¸åœ¨å†·å†»æœŸï¼Œéšæ—¶å¯ä¹°ï¼‰ã€‚

### ğŸ“ é‡ç‚¹ï¼šRest çŠ¶æ€çš„æ·±åˆ»ç†è§£
**ç–‘é—®**ï¼šä¸ºä»€ä¹ˆ `rest` å¯ä»¥ç”± `sold` è½¬ç§»è€Œæ¥ï¼Ÿæ˜æ˜ `sold` ä¹‹åæ˜¯å†·å†»æœŸå•Šï¼Ÿ
**è§£ç­”**ï¼š`rest` åœ¨ä»£ç ä¸­æ˜¯ä¸€ä¸ª **æ··åˆæ€ (Hybrid State)**ã€‚
*   **Day 1 (Sold)**: å–å‡ºã€‚
*   **Day 2 (Rest)**: ç»§æ‰¿è‡ª `Sold`ã€‚**ç‰©ç†å«ä¹‰ï¼šå†·å†»æœŸ**ã€‚å¯¼è‡´ä»Šå¤©æ— æ³•æ‰§è¡Œâ€œä¹°å…¥â€æ“ä½œï¼ˆå› ä¸ºä¹°å…¥åªèƒ½ä» `Rest` è½¬ç§»ï¼‰ã€‚
*   **Day 3 (Rest)**: ç»§æ‰¿è‡ª `Rest`ã€‚**ç‰©ç†å«ä¹‰ï¼šè‡ªç”±æœŸ**ã€‚å†·å†»ç»“æŸï¼Œä»Šå¤©å¯ä»¥ä¹°å…¥äº†ã€‚

### ğŸ”¢ çŠ¶æ€è½¬ç§»æ–¹ç¨‹
1.  **æŒæœ‰ (`hold`)**:
    *   ç»§æ‰¿æ˜¨å¤©æŒæœ‰ (`hold`)
    *   **åªèƒ½**ä»ä¼‘æ¯æ€ä¹°å…¥ (`rest - price`)ã€‚**ä¸èƒ½ä» sold ä¹°å…¥ï¼**
2.  **åˆšå– (`sold`)**:
    *   åªèƒ½ä»æŒæœ‰æ€å–å‡º (`hold + price`)
3.  **ä¼‘æ¯ (`rest`)**:
    *   ç»§æ‰¿æ˜¨å¤©ä¼‘æ¯ (`rest`)
    *   æ˜¨å¤©åˆšå–ï¼Œä»Šå¤©è¢«è¿«ä¼‘æ¯ (`sold`)

### ğŸ’» å…³é”®ä»£ç 
```python
class Solution:
    def maxProfit(self, prices: List[int]) -> int:
        hold = -prices[0]
        sold = 0
        rest = 0
        
        for i in range(1, len(prices)):
            prev_hold, prev_sold, prev_rest = hold, sold, rest
            
            # ä¹°å…¥å‰æï¼šå¿…é¡»æ˜¯è‡ªç”±èº«(rest)
            hold = max(prev_hold, prev_rest - prices[i])
            sold = prev_hold + prices[i]
            # ä¼‘æ¯æ¥æºï¼šç»§ç»­ä¼‘æ¯ æˆ– æ˜¨å¤©åˆšå–å®Œ(è¿›å…¥å†·å†»)
            rest = max(prev_rest, prev_sold)
            
        return max(sold, rest)
```

---

## é¢˜ç›®ä¸‰ï¼š714. å«æ‰‹ç»­è´¹çš„è‚¡ç¥¨äº¤æ˜“ (Transaction Fee)
**éš¾åº¦**: Medium
**é“¾æ¥**: [LeetCode 714](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-with-transaction-fee/)

### ğŸ’¡ è§£é¢˜æ€è·¯
å’Œ **æ— é™æ¬¡äº¤æ˜“ (122é¢˜)** é€»è¾‘å®Œå…¨ä¸€è‡´ï¼Œåªéœ€è¦åœ¨**å–å‡ºæ—¶åˆ»**ï¼ˆæˆ–è€…ä¹°å…¥æ—¶åˆ»ï¼‰æ‰£é™¤ä¸€æ¬¡æ‰‹ç»­è´¹å³å¯ã€‚

### ğŸ”¢ çŠ¶æ€è½¬ç§»
$$ \text{Sell} = \max(\text{Sell}, \text{Buy} + \text{Price} - \text{Fee}) $$

### ğŸ’» å…³é”®ä»£ç 
```python
class Solution:
    def maxProfit(self, prices: List[int], fee: int) -> int:
        hold = -prices[0]
        not_hold = 0
        
        for price in prices:
            hold = max(hold, not_hold - price)
            # å–å‡ºæ—¶æ‰£ç¨
            not_hold = max(not_hold, hold + price - fee)
            
        return not_hold
```

---

## ğŸ“Š è‚¡ç¥¨é—®é¢˜å…¨å®¶æ¡¶æ€»ç»“

| é¢˜ç›®ç‰¹å¾ | çŠ¶æ€æ•°é‡ | æ ¸å¿ƒåŒºåˆ« | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| **æ— é™æ¬¡** | 2 | `hold = max(hold, not_hold - price)` | ç”¨åˆ©æ¶¦ä¹°å…¥ |
| **1 æ¬¡** | 2 | `hold = max(hold, 0 - price)` | ç”¨æœ¬é‡‘0ä¹°å…¥ |
| **k æ¬¡** | 2k+1 | å¾ªç¯å¤„ç† k ç»„ä¹°å–çŠ¶æ€ | å¶æ•°å–ï¼Œå¥‡æ•°ä¹° |
| **å†·å†»æœŸ** | 3 | `hold` åªèƒ½ç”± `rest` è½¬ç§» | rest åŒ…å«å†·å†»å’Œè§‚æœ› |
| **æ‰‹ç»­è´¹** | 2 | `not_hold` å‡å» `fee` | ä¹Ÿå°±æ˜¯ 122é¢˜ - fee |